# =================================================
# AUTOMAZIONI SCIOPERI ITALIA V2.0
# =================================================

# ===============================================
# 1. NOTIFICA SCIOPERO VICINO DOMANI
# ===============================================
- alias: "Sciopero Vicino Domani"
  description: "Notifica alle 20:00 se ci sono scioperi vicini domani"
  trigger:
    - platform: time
      at: "20:00:00"
  condition:
    - condition: numeric_state
      entity_id: sensor.scioperi_domani
      above: 0
  action:
    - service: notify.mobile_app_phone
      data:
        title: "âš ï¸ Sciopero Domani"
        message: >
          ğŸš¨ {{ states('sensor.scioperi_domani') }} sciopero/i domani
          nel raggio di {{ state_attr('sensor.scioperi_vicini', 'radius_km') }}km!
          
          {% for strike in state_attr('sensor.scioperi_domani', 'strikes')[:3] %}
          â€¢ {{ strike.sector }} - {{ strike.region }} ({{ strike.distance }})
          {% endfor %}
        data:
          priority: high
          ttl: 0

# ===============================================
# 2. NOTIFICA SCIOPERO TPL VICINO
# ===============================================
- alias: "Sciopero TPL Vicino"
  description: "Notifica quando rileva sciopero TPL nel raggio"
  trigger:
    - platform: state
      entity_id: sensor.scioperi_tpl
  condition:
    - condition: template
      value_template: >
        {% set strikes = state_attr('sensor.scioperi_tpl', 'strikes') %}
        {{ strikes | selectattr('in_radius', 'equalto', true) | list | length > 0 }}
  action:
    - service: notify.telegram
      data:
        title: "ğŸšŒ Sciopero TPL Vicino"
        message: >
          Sciopero Trasporto Pubblico Locale rilevato nel tuo raggio!
          
          {% set strikes = state_attr('sensor.scioperi_tpl', 'strikes') %}
          {% for strike in strikes %}
          {% if strike.in_radius %}
          ğŸ“ {{ strike.region }} ({{ strike.distance }})
          ğŸ“… {{ strike.start_date }}
          â° {{ strike.modality }}
          {% endif %}
          {% endfor %}

# ===============================================
# 3. CONTROLLO PERCORSO CASA-LAVORO (Mattina)
# ===============================================
- alias: "Controlla scioperi nel percorso casa-lavoro"
  description: "Controlla scioperi lungo il percorso casa-lavoro ogni mattina"
  trigger:
    - platform: time
      at: "07:00:00"
  condition:
    - condition: state
      entity_id: binary_sensor.workday_sensor  # Opzionale
      state: "on"
  action:
    - service: scioperi_italia.check_route
      data:
        destination_lat: 44.7007  # Sostituisci con coordinate lavoro
        destination_lon: 8.0357
        radius_km: 10
    - wait_for_trigger:
        - platform: event
          event_type: scioperi_italia_route_check_result
      timeout: "00:00:05"
    - service: notify.mobile_app_phone
      data:
        title: "ğŸ“ Controllo Percorso"
        message: >
          {% if wait.trigger.event.data.strikes_found > 0 %}
          âš ï¸ {{ wait.trigger.event.data.strikes_found }} sciopero/i rilevati 
          lungo il tuo percorso casa-lavoro!
          {% else %}
          âœ… Nessuno sciopero lungo il percorso oggi
          {% endif %}

# ===============================================
# 4. NOTIFICA SCIOPERO SETTORI PREFERITI
# ===============================================
- alias: "Sciopero settori preferiti"
  description: "Notifica quando c'Ã¨ uno sciopero nei tuoi settori preferiti"
  trigger:
    - platform: state
      entity_id: sensor.scioperi_preferiti
  condition:
    - condition: numeric_state
      entity_id: sensor.scioperi_preferiti
      above: 0
  action:
    - service: scioperi_italia.notify_strike
      data:
        title: "â­ Sciopero Settore Preferito"
        message: >
          Nuovo sciopero rilevato in un tuo settore preferito!
          
          {% set strikes = state_attr('sensor.scioperi_preferiti', 'strikes') %}
          {% for strike in strikes[:2] %}
          â€¢ {{ strike.sector }}
          ğŸ“… {{ strike.start_date }}
          ğŸ“ {{ strike.region }} ({{ strike.distance }})
          {% endfor %}

# ===============================================
# 5. PROMEMORIA SCIOPERO OGGI
# ===============================================
- alias: "Promemoria sciopero oggi"
  description: "Notifica mattina se ci sono scioperi oggi"
  trigger:
    - platform: time
      at: "08:00:00"
  condition:
    - condition: numeric_state
      entity_id: sensor.scioperi_oggi
      above: 0
  action:
    - service: notify.persistent_notification
      data:
        title: "ğŸš¨ SCIOPERO OGGI"
        message: >
          Attenzione! {{ states('sensor.scioperi_oggi') }} sciopero/i in corso oggi.
          
          {% for strike in state_attr('sensor.scioperi_oggi', 'strikes') %}
          â€¢ {{ strike.sector }} - {{ strike.modality }}
          {% endfor %}

# ===============================================
# 6. MONITORAGGIO CONTINUO SCIOPERI VICINI
# ===============================================
- alias: "Monitora scioperi vicini"
  description: "Notifica quando cambiano scioperi nel raggio"
  trigger:
    - platform: state
      entity_id: sensor.scioperi_vicini
  condition:
    - condition: template
      value_template: "{{ trigger.to_state.state | int > trigger.from_state.state | int }}"
  action:
    - service: notify.mobile_app_phone
      data:
        title: "ğŸ“ Nuovo sciopero vicino"
        message: >
          Rilevato nuovo sciopero nel raggio di {{ state_attr('sensor.scioperi_vicini', 'radius_km') }}km!
          
          Totale: {{ states('sensor.scioperi_vicini') }} scioperi vicini
          
          Prossimo: {{ states('sensor.scioperi_prossimo_vicino') }}

# ===============================================
# 7. NOTIFICA SETTIMANALE RIEPILOGO
# ===============================================
- alias: "Riepilogo settimanale scioperi"
  description: "Riepilogo domenica sera degli scioperi della settimana"
  trigger:
    - platform: time
      at: "20:00:00"
  condition:
    - condition: time
      weekday:
        - sun
  action:
    - service: notify.telegram
      data:
        title: "ğŸ“Š Riepilogo scioperi settimana"
        message: >
          ğŸ“… Scioperi previsti prossima settimana:
          
          ğŸ¯ Nel tuo raggio: {{ states('sensor.scioperi_vicini') }}
          ğŸ“ Totali: {{ states('sensor.scioperi_totali') }}
          
          â­ Settori preferiti: {{ states('sensor.scioperi_preferiti') }}
          
          Prossimo vicino: {{ states('sensor.scioperi_prossimo_vicino') }}

# ===============================================
# 8. ALERT SONORO SCIOPERO OGGI
# ===============================================
- alias: "Alert sonoro sciopero oggi"
  description: "TTS quando c'Ã¨ sciopero oggi"
  trigger:
    - platform: numeric_state
      entity_id: sensor.scioperi_oggi
      above: 0
  condition:
    - condition: time
      after: "07:00:00"
      before: "09:00:00"
  action:
    - service: tts.google_translate_say
      entity_id: media_player.google_home
      data:
        message: >
          Attenzione! Oggi ci sono {{ states('sensor.scioperi_oggi') }} scioperi 
          in programma nel tuo raggio.

# ===============================================
# 9. EVENTO PERSONALIZZATO SCIOPERO DOMANI
# ===============================================
- alias: "Evento sciopero domani"
  description: "Ascolta eventi sciopero domani e agisci"
  trigger:
    - platform: event
      event_type: scioperi_italia_strike_tomorrow
  action:
    - service: light.turn_on
      target:
        entity_id: light.notification_light
      data:
        color_name: red
        brightness: 255
    - delay: "00:00:03"
    - service: light.turn_off
      target:
        entity_id: light.notification_light
    - service: notify.mobile_app_phone
      data:
        title: "âš ï¸ {{ trigger.event.data.sector }}"
        message: >
          Sciopero domani: {{ trigger.event.data.sector }}
          Distanza: {{ trigger.event.data.distance }}km
          ModalitÃ : {{ trigger.event.data.modality }}
