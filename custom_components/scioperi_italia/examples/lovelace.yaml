# =================================================
# DASHBOARD LOVELACE SCIOPERI ITALIA V2.0
# Con visualizzazione mappa e sensori location-aware
# =================================================

# ===============================================
# VISTA COMPLETA SCIOPERI
# ===============================================
views:
  - title: Scioperi
    path: scioperi
    icon: mdi:alert-circle
    badges: []
    cards:
      # ============ RIEPILOGO RAPIDO ============
      - type: horizontal-stack
        cards:
          - type: statistic
            entity: sensor.scioperi_vicini
            name: Vicini
            icon: mdi:map-marker-radius
            unit: nel raggio
          - type: statistic
            entity: sensor.scioperi_oggi
            name: Oggi
            icon: mdi:calendar-today
          - type: statistic
            entity: sensor.scioperi_domani
            name: Domani
            icon: mdi:calendar-tomorrow

      # ============ PROSSIMO SCIOPERO VICINO ============
      - type: entities
        title: ðŸŽ¯ Prossimo sciopero vicino
        entities:
          - entity: sensor.scioperi_prossimo_vicino
            name: Data e Distanza
          - type: attribute
            entity: sensor.scioperi_prossimo_vicino
            attribute: sector
            name: Settore
          - type: attribute
            entity: sensor.scioperi_prossimo_vicino
            attribute: region
            name: Regione
          - type: attribute
            entity: sensor.scioperi_prossimo_vicino
            attribute: modality
            name: ModalitÃ 
          - type: attribute
            entity: sensor.scioperi_prossimo_vicino
            attribute: distance_km
            name: Distanza
            suffix: " km"

      # ============ MAPPA SCIOPERI (Opzionale con custom card) ============
      - type: map
        title: ðŸ“ Mappa scioperi
        default_zoom: 8
        entities:
          - entity: zone.home
            label_mode: name

      # ============ MARKDOWN INFO DETTAGLIATE ============
      - type: markdown
        title: ðŸ“Š Dettagli scioperi vicini
        content: |
          **Raggio configurato:** {{ state_attr('sensor.scioperi_vicini', 'radius_km') }}km
          **Casa:** {{ state_attr('sensor.scioperi_vicini', 'home_location') }}
          
          ---
          
          {% if state_attr('sensor.scioperi_vicini', 'strikes') %}
          ### Scioperi nel Raggio:
          {% for strike in state_attr('sensor.scioperi_vicini', 'strikes')[:5] %}
          **{{ loop.index }}. {{ strike.sector }}**
          - ðŸ“… Data: {{ strike.start_date }}
          - ðŸ“ Luogo: {{ strike.region }}
          - ðŸŽ¯ Distanza: {{ strike.distance }}
          - â° ModalitÃ : {{ strike.modality }}
          
          {% endfor %}
          {% else %}
          âœ… **Nessuno sciopero nel raggio configurato**
          {% endif %}

      # ============ SETTORI - GRID ============
      - type: grid
        title: ðŸš¦ Scioperi per settore
        columns: 3
        square: false
        cards:
          - type: statistic
            entity: sensor.scioperi_tpl
            name: TPL
            icon: mdi:bus
          - type: statistic
            entity: sensor.scioperi_aereo
            name: Aerei
            icon: mdi:airplane
          - type: statistic
            entity: sensor.scioperi_ferroviario
            name: Treni
            icon: mdi:train
          - type: statistic
            entity: sensor.scioperi_trasporto_merci_e_logistica
            name: Logistica
            icon: mdi:truck
          - type: statistic
            entity: sensor.scioperi_marittimo
            name: Marittimo
            icon: mdi:ferry
          - type: statistic
            entity: sensor.scioperi_preferiti
            name: Preferiti
            icon: mdi:star

      # ============ CALENDARIO ============
      - type: calendar
        title: ðŸ“… Calendario scioperi
        entities:
          - calendar.scioperi_italia
        initial_view: listWeek

      # ============ AZIONI RAPIDE ============
      - type: entities
        title: âš¡ Azioni
        entities:
          - type: button
            name: ðŸ”„ Aggiorna dati
            icon: mdi:refresh
            tap_action:
              action: call-service
              service: scioperi_italia.refresh_data
          - type: button
            name: ðŸ”” Notifica stato
            icon: mdi:bell
            tap_action:
              action: call-service
              service: scioperi_italia.notify_strike
          - type: button
            name: ðŸ“ Controlla percorso
            icon: mdi:map-marker-path
            tap_action:
              action: call-service
              service: scioperi_italia.check_route
              service_data:
                destination_lat: 44.7007
                destination_lon: 8.0357
                radius_km: 10

      # ============ SETTORI PREFERITI (se configurati) ============
      - type: conditional
        conditions:
          - condition: numeric_state
            entity: sensor.scioperi_preferiti
            above: 0
        card:
          type: markdown
          title: â­ Scioperi settori preferiti
          content: |
            {% set strikes = state_attr('sensor.scioperi_preferiti', 'strikes') %}
            {% set sectors = state_attr('sensor.scioperi_preferiti', 'favorite_sectors') %}
            
            **Settori monitorati:** {{ sectors | join(', ') }}
            
            ---
            
            {% for strike in strikes[:5] %}
            **{{ strike.sector }}**
            - ðŸ“… {{ strike.start_date }}
            - ðŸ“ {{ strike.region }}
            - ðŸŽ¯ {{ strike.distance }}
            {% if strike.in_radius %}âœ… Nel raggio{% endif %}
            
            {% endfor %}

# ===============================================
# CARD SINGOLE ALTERNATIVE
# ===============================================

# ============ CARD MINI - Solo Conteggi ============
mini_card:
  type: glance
  title: Scioperi
  entities:
    - entity: sensor.scioperi_vicini
      name: Vicini
    - entity: sensor.scioperi_oggi
      name: Oggi
    - entity: sensor.scioperi_domani
      name: Domani
    - entity: sensor.scioperi_totali
      name: Totali

# ============ CARD ALERT - Sciopero Oggi ============
alert_card:
  type: conditional
  conditions:
    - condition: numeric_state
      entity: sensor.scioperi_oggi
      above: 0
  card:
    type: markdown
    content: |
      # ðŸš¨ SCIOPERO OGGI!
      
      ### {{ states('sensor.scioperi_oggi') }} sciopero/i in corso
      
      {% for strike in state_attr('sensor.scioperi_oggi', 'strikes') %}
      **{{ strike.sector }}**
      - {{ strike.region }}
      - {{ strike.modality }}
      - {{ strike.distance }}
      {% endfor %}
    card_mod:
      style: |
        ha-card {
          background: rgba(255, 0, 0, 0.1);
          border-left: 4px solid red;
        }

# ============ CARD GAUGE - Scioperi Vicini ============
gauge_card:
  type: gauge
  entity: sensor.scioperi_vicini
  name: Scioperi nel raggio
  unit: scioperi
  min: 0
  max: 10
  severity:
    green: 0
    yellow: 2
    red: 5

# ============ BUTTON CARD CUSTOM ============
button_card_custom:
  type: custom:button-card
  entity: sensor.scioperi_vicini
  name: Scioperi vicini
  show_state: true
  state:
    - value: 0
      color: green
      icon: mdi:check-circle
    - value: 1
      color: orange
      icon: mdi:alert
      operator: '>='
    - value: 3
      color: red
      icon: mdi:alert-circle
      operator: '>='
  tap_action:
    action: more-info

# ============ MUSHROOM CARDS (se installate) ============
mushroom_entity:
  type: custom:mushroom-entity-card
  entity: sensor.scioperi_vicini
  name: Scioperi vicini
  icon: mdi:map-marker-radius
  icon_color: |
    {% if states('sensor.scioperi_vicini') | int == 0 %}
    green
    {% elif states('sensor.scioperi_vicini') | int < 3 %}
    orange
    {% else %}
    red
    {% endif %}

mushroom_chips:
  type: custom:mushroom-chips-card
  chips:
    - type: entity
      entity: sensor.scioperi_oggi
      icon: mdi:calendar-today
      icon_color: red
    - type: entity
      entity: sensor.scioperi_domani
      icon: mdi:calendar-tomorrow
      icon_color: orange
    - type: entity
      entity: sensor.scioperi_vicini
      icon: mdi:map-marker-radius
      icon_color: blue

# ============ AUTO-ENTITIES (filtra scioperi attivi) ============
auto_entities_card:
  type: custom:auto-entities-card
  card:
    type: entities
    title: Sensori scioperi attivi
  filter:
    include:
      - entity_id: "sensor.scioperi_*"
        state: "> 0"
    exclude:
      - entity_id: "*totali*"
  sort:
    method: state
    reverse: true

# ============ APEXCHARTS (Grafico Scioperi) ============
apex_chart:
  type: custom:apexcharts-card
  header:
    show: true
    title: Trend scioperi
  series:
    - entity: sensor.scioperi_vicini
      name: Vicini
      type: column
    - entity: sensor.scioperi_oggi
      name: Oggi
      type: line
    - entity: sensor.scioperi_domani
      name: Domani
      type: line
